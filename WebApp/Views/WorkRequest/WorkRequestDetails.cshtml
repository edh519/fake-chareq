@model BusinessLayer.ViewModels.WorkRequestDetailsViewModel
@using BusinessLayer.ViewModels;
@using Enums;
@using Enums.Enums
@using Microsoft.AspNetCore.Identity;
@using WebApp.Controllers
@inject UserManager<ApplicationUser> _userManager

@{
    ViewBag.Title = $"{Model.Trial} | {Model.DisplayTitle}";

    // Variables used to determine visibility and state of various elements.
    string isMyConvoPosition = "";
    string isMyConvoBorder = "convo-box-you";
    DateTime lastUsedDate = Model.CreationDateTime;

    if (Model.IsLoggedInUserRequester)
    {
        isMyConvoPosition = "offset-2";
        isMyConvoBorder = "convo-box-me";
    }

    //Change the panel header if it's a Type: User
    string hiddenPanelHeader = Model.IsLoggedInUserOfRoleTypeUser
    ? ""
    : " Panel";

    bool subscribeOthers = !Model.IsLoggedInUserOfRoleTypeUser || Model.IsLoggedInUserRequester;

    bool isClosed = Model.Status == (int)WorkRequestStatusEnum.Completed || Model.Status == (int)WorkRequestStatusEnum.Abandoned;

    List<WorkRequestEventTypeEnum> closedWorkRequestEvents = new List<WorkRequestEventTypeEnum>
    {
        WorkRequestEventTypeEnum.Complete,
            WorkRequestEventTypeEnum.Closed,
    };

    List<WorkRequestEventTypeEnum> auditLogWorkRequestEvents = new List<WorkRequestEventTypeEnum>
        {
            WorkRequestEventTypeEnum.Assignment,
            WorkRequestEventTypeEnum.Label,
            WorkRequestEventTypeEnum.GHIssueAttachment,
            WorkRequestEventTypeEnum.Export,
            WorkRequestEventTypeEnum.FileManagement,
            WorkRequestEventTypeEnum.Subscription
        };

    string isExported = ((bool)ViewBag.IsExported ? "true" : "false");
}

@section Styles {
    <link rel="stylesheet" href="~/css/work-request-details.css" asp-append-version="true" />
}

@section Scripts {
    <script asp-src-include="~/js/Pages/WorkRequestDetails.js" asp-append-version="true"></script>
    <script asp-src-include="~/js/FileUploads.js" asp-append-version="true"></script>
    <script asp-src-include="~/js/Pages/_WorkRequestLabelEditorPartial.js" asp-append-version="true"></script>
    <script asp-src-include="~/js/Pages/_WorkRequestAssigneePartial.js" asp-append-version="true"></script>
    <script asp-src-include="~/js/Pages/_WorkRequestGitHubPartial.js" asp-append-version="true"></script>
    <script asp-src-include="~/js/Pages/_WorkRequestSubTaskPartial.js" asp-append-version="true"></script>
}

@*Light Box*@
<div id="lightbox" class="lightbox-overlay">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-image" src="" alt="" class="lightbox-content" />
</div>

<div id="container" class="container">
    <div class="row">
        <!-- Side Panel -->
        <div id="sidePanel" class="col-12 order-1 col-xl-3 order-xl-2 col-lg-6 order-lg-2">

            <div class="card my-1" style="">
                <div class="card-header">
                    <b class="float-left">Details<span class="d-none" name="sidepanel-inversecollapse">@hiddenPanelHeader</span></b>

                    <a class="float-end pointerOnHover mx-2" onclick="toggleWidescreen(this)">
                        <i class="fas fa-expand-arrows-alt text-color-theme" title="Use widescreen mode"></i>
                    </a>

                    <a class="float-end pointerOnHover" onclick="toggleSidePanelCollapse(this)" data-bs-toggle="collapse" data-bs-target=".sidepanel-collapse" aria-expanded="true" aria-controls="sidepanel-collapse1 sidepanel-collapse2 sidepanel-collapse3 sidepanel-collapse4 sidepanel-collapse5">
                        <i class="fas fa-eye-slash text-color-theme" title="Hide details panel" data-bs-toggle="tooltip"></i>
                    </a>
                </div>
                <div class="card-body py-2 sidepanel-collapse collapse show" id="sidePanel-collapse1">
                    <p class="py-0 mb-1">
                        <b>Status: </b>

                        <input type="hidden" asp-for="Status" />

                        @if (Model.Status == (int)WorkRequestStatusEnum.Abandoned)
                        {
                            <span class="badge rounded-pill bg-danger font-size-1rem fw-normal text-white">Closed</span>
                        }
                        else if (Model.Status == (int)WorkRequestStatusEnum.Completed)
                        {
                            <span class="badge rounded-pill bg-success font-size-1rem fw-normal text-white">Done</span>
                        }
                        else if (Model.Status == (int)WorkRequestStatusEnum.PendingInitialApproval)
                        {
                            <span class="badge rounded-pill bg-primary font-size-1rem fw-normal text-white">Awaiting decision</span>
                        }
                        else if (Model.Status == (int)WorkRequestStatusEnum.PendingCompletion)
                        {
                            <span class="badge rounded-pill bg-primary font-size-1rem fw-normal text-white">Awaiting work</span>
                        }
                        else if (Model.Status == (int)WorkRequestStatusEnum.PendingRequester)
                        {
                            <span class="badge rounded-pill bg-warning font-size-1rem fw-normal text-black">More details required</span>
                        }
                    </p>
                    <p class="py-0 mb-1" data-bs-toggle="tooltip" data-bs-placement="right" title="@Model.CreationDateTime.ToString("HH:mm dd/MM/yyyy")">
                        <b>Created: </b>@Model.CreationDateTime.ToString("d MMM yyyy")
                    </p>
                    @if (isClosed)
                    {
                        <p class="py-0 mb-1" 
                           data-bs-toggle="tooltip" data-bs-placement="right" 
                           title="@Model.WorkRequestEvents.Last(x=>
                                    x.WorkRequestEventType == WorkRequestEventTypeEnum.Closed
                                    || x.WorkRequestEventType == WorkRequestEventTypeEnum.Complete
                                    ).CreatedAt.ToString("HH:mm dd/MM/yyyy")">
                        <b>
                            @(Model.Status == (int)WorkRequestStatusEnum.Completed ? "Completed" : "Closed"):
                        </b>
                        @Model.WorkRequestEvents.Last(x =>
                                                x.WorkRequestEventType == WorkRequestEventTypeEnum.Closed
                                                || x.WorkRequestEventType == WorkRequestEventTypeEnum.Complete
                                                ).CreatedAt.ToString("d MMM yyyy")
                    </p>
                    <div class="py-0 mb-1" data-bs-toggle="tooltip" data-bs-placement="left"
                         title="Export Work Request Data">
                        <form asp-action="ExportWorkRequest" asp-controller="WorkRequest"
                              asp-route-workRequestId="@Model.WorkRequestId" method="post">
                            <button type="submit" class="btn btn-sm btn-primary text-white font-size-1rem fw-normal pointerOnHover">
                                Export
                            </button>
                        </form>
                    </div>
                                        }
                    <p class="py-0 mb-1">
                        @if (@Model.ViewerIsSubscribed)
                        {
                            <a class="btn btn-sm btn-warning text-black font-size-1rem fw-normal pointerOnHover"
                               data-workrequestid="@Model.WorkRequestId"
                               data-currentuserid="@_userManager.GetUserAsync(User).Result.Id"
                               data-targetuserid="@_userManager.GetUserAsync(User).Result.Id"
                               data-request-url="@Url.Action(nameof(WorkRequestController.UnsubscribeUserFromRequest), "WorkRequest")"
                               onclick="SubscribeUnsubscribeUserWorkRequest(this)"
                               data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unsubscribe from updates">Unsubscribe</a>
                        }
                        else
                        {
                            <a class="btn btn-sm btn-info text-black font-size-1rem fw-normal pointerOnHover"
                               data-workrequestid="@Model.WorkRequestId"
                               data-currentuserid="@_userManager.GetUserAsync(User).Result.Id"
                               data-targetuserid="@_userManager.GetUserAsync(User).Result.Id"
                               data-request-url="@Url.Action(nameof(WorkRequestController.SubscribeUserToRequest), "WorkRequest")"
                               onclick="SubscribeUnsubscribeUserWorkRequest(this)" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Subscribe to updates">Subscribe</a>
                        }
                        @if (subscribeOthers)
                            {
                                 <button class="btn btn-sm btn-info text-black font-size-1rem fw-normal pointerOnHover"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="Subscribe others" onclick="SubscribeOtherUser(this)">
                                        <i class="fas fa-users"></i>
                                    <span class="visually-hidden">Toggle Subscribe Others</span>
                                </button>    
                            }
                       
                    </p>
                    @if (@Model.TrialEmail == null)
                    {
                        <span data-bs-toggle="tooltip"
                              data-bs-placement="bottom"
                              data-bs-title="Admins can configure this trial email through 'Manage Trials'">
                            <a class="btn btn-sm btn-secondary text-white font-size-1rem fw-normal disabled pointerOnHover"
                               tabindex="-1"
                               aria-disabled="true">
                                Trial Email is not configured
                            </a>
                        </span>
                    }
                    else if (@Model.TrialEmailIsSubscribed)
                    {
                        <a class="btn btn-sm btn-warning text-black font-size-1rem fw-normal pointerOnHover"
                           data-workrequestid="@Model.WorkRequestId"
                       data-currentuserid="@_userManager.GetUserAsync(User).Result.Id"
                       data-targetuserid="@Model.TrialEmail.Id"
                           data-request-url="@Url.Action(nameof(WorkRequestController.UnsubscribeUserFromRequest), "WorkRequest")"
                           data-bs-toggle="tooltip"
                           data-bs-placement="bottom"
                           data-bs-title="Trial Email: @Model.TrialEmail.Email"
                           onclick="SubscribeUnsubscribeUserWorkRequest(this)">
                            Unsubscribe Trial Email
                        </a>
                    }
                    else
                    {
                    <a class="btn btn-sm btn-info text-black font-size-1rem fw-normal pointerOnHover"
                       data-workrequestid="@Model.WorkRequestId"
                       data-currentuserid="@_userManager.GetUserAsync(User).Result.Id"
                       data-targetuserid="@Model.TrialEmail.Id"
                       data-request-url="@Url.Action(nameof(WorkRequestController.SubscribeUserToRequest), "WorkRequest")"
                       data-bs-toggle="tooltip"
                       data-bs-placement="bottom"
                       data-bs-title="Trial Email: @Model.TrialEmail.Email"
                       onclick="SubscribeUnsubscribeUserWorkRequest(this)">
                        Subscribe Trial Email</a>
                    }
                </div>
            </div>

            <div class="card my-1 sidepanel-collapse collapse show" id="sidepanel-collapse2">
                <partial name="_WorkRequestAssigneePartial" model="Model.AssigneesViewModel" />
            </div>

            <div class="card my-1 sidepanel-collapse collapse show" id="sidepanel-collapse3">
                <partial name="_WorkRequestLabelEditorPartial" model="Model.LabelsEditorViewModel" />
            </div>

            <div class="card my-1 sidepanel-collapse collapse show" id="sidepanel-collapse5">
                <partial name="_WorkRequestSubTaskPartial" model="Model.SubTaskViewModel" />
            </div>

            @if (!Model.IsLoggedInUserOfRoleTypeUser)
            {
                <div class="card my-1 sidepanel-collapse collapse show" id="sidepanel-collapse4">
                    <partial name="_WorkRequestGitHubPartial" model="Model.GitHubViewModel" />
                </div>
            }
        </div>

        <!-- Conversation View -->
        <div id="conversationContent" class="col-12 order-2 col-xl-9 order-xl-1 col-lg-6 order-lg-1">

            <div id="printOnlyTitle" class="row">
                <div class="col">
                    <h3 class="text-center mb-3">Request Log</h3>
                </div>
            </div>

            <!-- Initial Entry is creation details -->
            <div class="row text-center text-muted-theme-toggle">
                <div class="col">
                    <hr />
                </div>

                <div class="col-auto">
                    <span class="badge rounded-pill font-italic text-muted-theme-toggle">@Model.CreationDateTime.ToString("dddd d MMMM yyyy")</span>
                </div>

                <div class="col">
                    <hr />
                </div>
            </div>

            @if (Model.IsLoggedInUserRequester)
            {
                isMyConvoPosition = "offset-2";
                isMyConvoBorder = "convo-box-me";
            }

            <div class="row">
                <div class="col-10 @isMyConvoPosition bg-theme">
                    <div class="alert border-primary @isMyConvoBorder pb-4 chareq-message-box">
                        <h4 class="alert-heading">
                            @if (Model.Trial == "Other")
                            {
                                <b>Other: @Model.TrialOther</b>
                            }
                            else
                            {
                                <b>@Model.Trial</b>
                            }
                            @if (!Model.IsLoggedInUserOfRoleTypeUser)
                            {
                                <a class="card-link" data-bs-toggle="collapse" href="#editProjectWrapper" role="button" aria-expanded="false" aria-controls="editProjectWrapper"><i class="fa fa-wrench" data-bs-toggle="tooltip" title="Edit Project"></i><span class="visually-hidden">Edit Project</span></a>
                            }
                            <span class="fw-light fs-3 ms-1 cursor-pointer" id="copyUrlElement">
                                #@Model.WorkRequestId
                            </span>
                            @if (!Model.IsLoggedInUserOfRoleTypeUser)
                            {
                                <span class="collapse input-group mt-1 w-50" id="editProjectWrapper">
                                    <label for="editProjectSelect" span="visually-hidden">Edit Project</label>
                                    <select class="form-control validate" id="editProjectSelect" required>
                                        @foreach (Trial project in Model.Trials.Where(q => q.TrialId != 1000))
                                        {
                                            @if (project.TrialName == Model.Trial)
                                            {
                                                <option value="@project.TrialId" selected>@project.TrialName</option>

                                            }
                                            else
                                            {
                                                <option value="@project.TrialId">@project.TrialName</option>
                                            }
                                        }
                                    </select>
                                    <span class="input-group-append">
                                        <button class="btn btn-primary input-group-append" onclick="UpdateWorkRequestProject(@Model.WorkRequestId, $('#editProjectSelect').val())">Update</button>
                                    </span>
                                </span>
                            }
                        </h4>
                        @* @if (Model.LastEditedDateTime != default)
                        {
                            <small class="float-end text-muted-theme-toggle" title="@Model.LastEditedDateTime.ToString("HH:mm dd/MM/yyyy")" data-bs-toggle="tooltip" data-bs-placement="right"><i>Last edited<i class="fa fa-info-circle ms-2"></i></i></small>
                        } *@
                        <h4 class="alert-heading">@Model.DisplayTitle</h4>
                        <p>@Html.Raw(@Model.DetailDescription)</p> @*Careful Raw html*@

                        @foreach (FileUpload file in Model.SupportingFiles)
                        {
                            <div class="pt-1 text-muted-theme-toggle">
                                <span>@file.ReadableFileName</span>
                                <a href="#" class="badge bg-primary small ms-2 text-white" 
                                    data-bs-tooltip="tooltip" data-bs-placement="right" title="Download this file"
                                    onclick="DownloadFile(@file.FileUploadId, '@file.ReadableFileName');">
                                    <i class="fa fa-download"></i>
                                </a>
                                <form method="post" asp-action="DeleteSupportingFile" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="fileId" value="@file.FileUploadId" />
                                    <input type="hidden" name="workRequestId" value="@Model.WorkRequestId" />
                                    <a class="btn pointerOnHover text-danger"
                                        data-bs-toggle="tooltip" data-bs-placement="right" title="Delete this file"
                                        onclick="confirmDelete(this, '@file.ReadableFileName')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </form>
                            </div>
                        }
                        <button type="button"
                                class="btn btn-link p-0 float-end text-muted-theme-toggle cursor-pointer text-decoration-none"
                                data-bs-toggle="tooltip"
                                data-email="@Model.CreatedBy"
                                onclick="copyEmailToClipboard(this)"
                                title="@Model.CreatedBy | @Model.CreationDateTime.ToString("HH:mm dd/MM/yyyy")">

                            <small>
                                @BusinessLayer.Helpers.CommonHelpers.RemoveDomainFromEmail(Model.CreatedBy)
                                | @Model.CreationDateTime.ToShortTimeString()
                            </small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- New conversation view - convo first then date! -->
            @foreach (var item in Model.ConversationViewItems)
            {
                if (item.CreatedAt.Date != lastUsedDate.Date)
                {
                    <div class="row text-center text-muted-theme-toggle">
                        <div class="col"><hr /></div>
                        <div class="col-auto">
                            <span class="badge rounded-pill font-italic text-muted-theme-toggle">
                                @item.CreatedAt.ToString("dddd d MMMM yyyy")
                            </span>
                        </div>
                        <div class="col"><hr /></div>
                    </div>

                    lastUsedDate = item.CreatedAt;
                }

                if (item.SubTasks != null)
                {
                    <partial name="_SubTaskAccordionPartial" model="item.SubTasks" />
                }
                else if (item.WorkRequestEvent != null)
                {
                    var workRequestEvent = item.WorkRequestEvent;

                    if (_userManager.FindByNameAsync(User.Identity.Name).Result.NormalizedEmail == workRequestEvent.CreatedByEmail.ToUpperInvariant())
                    {
                        isMyConvoPosition = "offset-2";
                        isMyConvoBorder = "convo-box-me";
                    }
                    else
                    {
                        isMyConvoPosition = "";
                        isMyConvoBorder = "convo-box-you";
                    }

                    string conversationTypeBorder = workRequestEvent.WorkRequestEventType switch
                    {
                        WorkRequestEventTypeEnum.Approve => "border-primary",
                        WorkRequestEventTypeEnum.Enquiry => "border-warning",
                        WorkRequestEventTypeEnum.Complete => "border-success",
                        WorkRequestEventTypeEnum.Closed => "border-danger",
                        _ => "border-secondary"
                    };

                    <div class="row">
                        <div class="col-10 @isMyConvoPosition bg-theme">
                            @if (auditLogWorkRequestEvents.Contains(workRequestEvent.WorkRequestEventType))
                            {
                                <div class="pb-1">
                                    <p class="font-italic mx-4">@Html.Raw(workRequestEvent.Content)</p>
                                </div>
                            }
                            else
                            {
                                <div class="alert @conversationTypeBorder @isMyConvoBorder pb-4 chareq-message-box">
                                    @if (workRequestEvent.WorkRequestEventType != WorkRequestEventTypeEnum.None)
                                    {
                                        <p class="alert-heading text-muted-theme-toggle">
                                            <span><i class="fa fa-arrow-right" aria-hidden="true"></i>&nbsp;</span>
                                            @{
                                                var displayName = EnumHelpers.GetDisplayName(workRequestEvent.WorkRequestEventType);
                                                if (displayName == "Request Changes")
                                                {
                                                    <span>Requested Changes</span>
                                                }
                                                else if (displayName == "Approve")
                                                {
                                                    <span>Approved</span>
                                                }
                                                else if (displayName == "Complete")
                                                {
                                                    <span>Completed</span>
                                                }
                                                else if (displayName == "Close")
                                                {
                                                    <span>Closed</span>
                                                }
                                                else
                                                {
                                                    @displayName
                                                }
                                            }
                                        </p>
                                    }
                                    <p>@Html.Raw(workRequestEvent.Content)</p>
                                    @if (workRequestEvent.DurationDays.HasValue && workRequestEvent.DurationDays > 0)
                                    {
                                        <p>
                                            <i class="small">Duration Estimate: @workRequestEvent.DurationDays @(workRequestEvent.DurationDays == 1 ? "day" : "days")</i>
                                        </p>
                                    }
                                    <small class="float-end text-muted-theme-toggle cursor-pointer"
                                           data-bs-toggle="tooltip"
                                           data-email="@workRequestEvent.CreatedByEmail"
                                           onclick="copyEmailToClipboard(this)"
                                           title="@workRequestEvent.CreatedByEmail | @workRequestEvent.CreatedAt.ToString("HH:mm dd/MM/yyyy")">
                                        @BusinessLayer.Helpers.CommonHelpers.RemoveDomainFromEmail(workRequestEvent.CreatedByEmail)
                                        | @workRequestEvent.CreatedAt.ToShortTimeString()
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        @if (isClosed)
            {
                @if (Model.ProcessDeviationReason != null)
                {
                    <div class="alert-danger p-2 mx-0 rounded">
                        <h5 id="screenDeviationWarning">Reason for Deviation<i class="fa fa-info-circle ms-1" title="The user completing this request filled out multiple steps." data-bs-toggle="tooltip"></i></h5>
                        <h5 id="printDeviationWarning">Reason for user involved in multiple action stages</h5>
                        <p>@Model.ProcessDeviationReason.Reason</p>

                        @{
                            WorkRequestEventViewModel closedEvent = Model.WorkRequestEvents.Where(i => closedWorkRequestEvents.Contains(i.WorkRequestEventType)).FirstOrDefault();
                        }
                        <small class="cursor-pointer"
                                data-bs-toggle="tooltip"
                               data-email="@closedEvent.CreatedByEmail"
                                onclick="copyEmailToClipboard(this)"
                               title="@closedEvent.CreatedByEmail | @closedEvent.CreatedAt.ToString("HH:mm dd/MM/yyyy")">
                            @BusinessLayer.Helpers.CommonHelpers.RemoveDomainFromEmail(closedEvent.CreatedByEmail) | @closedEvent.CreatedAt.ToShortTimeString()
                        </small>


                    </div>
                }
                <div class="text-center">
                <button id="additionalMessageButton"
                 class="btn btn-primary my-3"
                            onclick="showAdditionalMessageTextBox(@isExported)">
                 Add additional message
                </button>
                    <p id="disclaimer" class="text-center" style="display: none;">
                        Note: As this work request is closed, any further work should be submitted as a new work request.
                    </p>

                    <p id="exportDisclaimer" class="text-center text-danger fw-bold" style="display:none;">
                        This work request has already been exported.<br />
                        Adding an additional message will make the exported data file out of date.<br />
                        Are you sure you want to continue?
                    </p>

                </div>
            }

            <!-- Entry Field -->          
            @if (!isClosed)
            {  
                <div class="text-center">
                <button id="showTextBoxButton"
                 class="btn btn-warning my-3 d-none"
                 onclick="collapseAllSubtasks()">
                 Sub tasks are expanded. Click here to collapse and show the text box.
                </button>
                </div>
            }
            <div id="mainTextBoxWrapper" style="@(isClosed ? "display:none;" : "")">
                <form id="eventForm" asp-action="CreateWorkRequestEvent" role="form" method="post" enctype="multipart/form-data">
                    <input asp-for="WorkRequestId" type="hidden" />

                    <hr class="my-3" />

                    <div class="row">
                        <div class="col-12">
                            <label for="eventTextEntry_0" class="form-label visually-hidden">
                                Message
                            </label>

                            <textarea id="eventTextEntry_0"
                                      class="form-control htmlForm"
                                      spellcheck="true"
                                      placeholder="Type a message..."
                                      required
                                      rows="5"
                                      asp-for="NewWorkRequestEvent.Content">
                            </textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-3">
                            <span class="input-group my-1">
                                <label for="fileUpload" class="btn btn-primary text-white">
                                    <svg aria-hidden="true" focusable="false" class="octicon octicon-paperclip" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" display="inline-block" overflow="visible" style="vertical-align: text-bottom;">
                                        @*SVG path taken from github*@
                                        <path d="M12.212 3.02a1.753 1.753 0 0 0-2.478.003l-5.83 5.83a3.007 3.007 0 0 0-.88 2.127c0 .795.315 1.551.88 2.116.567.567 1.333.89 2.126.89.79 0 1.548-.321 2.116-.89l5.48-5.48a.75.75 0 0 1 1.061 1.06l-5.48 5.48a4.492 4.492 0 0 1-3.177 1.33c-1.2 0-2.345-.487-3.187-1.33a4.483 4.483 0 0 1-1.32-3.177c0-1.195.475-2.341 1.32-3.186l5.83-5.83a3.25 3.25 0 0 1 5.553 2.297c0 .863-.343 1.691-.953 2.301L7.439 12.39c-.375.377-.884.59-1.416.593a1.998 1.998 0 0 1-1.412-.593 1.992 1.992 0 0 1 0-2.828l5.48-5.48a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-5.48 5.48a.492.492 0 0 0 0 .707.499.499 0 0 0 .352.154.51.51 0 0 0 .356-.154l5.833-5.827a1.755 1.755 0 0 0 0-2.481Z"></path>
                                    </svg>
                                    @*Text changed in js\Pages\WorkRequestDetails.js*@
                                    <span id="fileUploadLabelText"> Attach files</span>
                                </label>
                                <input id="fileUpload" name="NewSupportingFiles" type="file" multiple />
                            </span>
                        </div>
                        <div class="col-5">
                            <span class="input-group my-1" id="duration-days-wrapper">
                                <label for="duration-days" class="visually-hidden">Duration estimate (days)</label>
                                <input type="number" class="form-control" asp-for="NewWorkRequestEvent.DurationDays" id="duration-days" min="0" max="999" step="0.5" placeholder="Duration Estimate" />
                                <div class="input-group-append me-1">
                                    <span class="input-group-text" style="border-radius: 0 5px 5px 0;" id="duration-days-units">days</span>
                                </div>
                                <span class="col-form-label me-1"><i class="fas fa-info-circle text-info" title="Quickly add days to duration estimation" data-bs-toggle="tooltip"></i></span>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" value="0" onclick="QuickAddEstimate_Click(this.value)" title="Clear duration estimate" data-bs-toggle="tooltip">Clear</button>
                                </div>
                            </span>
                        </div>
                        <div class="col-4 d-flex justify-content-end">
                            @if (!Model.IsLoggedInUserOfRoleTypeUser)
                            {
                                <span class="input-group my-1">
                                    <label for="eventTypeSelect_0" class="visually-hidden">Event type</label>

                                    <select id="eventTypeSelect_0"
                                            class="form-control"
                                            asp-for="NewWorkRequestEvent.EventType.WorkRequestEventTypeId"
                                            asp-items="Model.AllowedEventTypes.Select(x => new SelectListItem{
                                                Text = EnumHelpers.GetDisplayName(x),
                                                Value = ((int)x).ToString()
                                            })"
                                            onchange="EmptyDescriptionCheck(0)"
                                            required>
                                        <option selected disabled>Select type</option>
                                    </select>

                                    <span id="textboxButtonWrapper_0"
                                          data-bs-toggle="tooltip"
                                          title="Message content cannot be empty"
                                          style="display:inline-block;">
                                        <button id="textboxButton_0"
                                                class="btn btn-primary text-white"
                                                type="submit"
                                                role="button" disabled>
                                            Add
                                        </button>
                                    </span>
                                </span>
                            }
                            else
                            {
                                <input id="eventTypeSelect_0" asp-for="NewWorkRequestEvent.EventType.WorkRequestEventTypeId" value="1" type="hidden">

                                <span id="textboxButtonWrapper_0"
                                      data-bs-toggle="tooltip"
                                      title="Message content cannot be empty"
                                      style="display:inline-block;">
                                    <button id="textboxButton_0"
                                            class="btn btn-primary text-white"
                                            type="submit"
                                            role="button" disabled>
                                        Send
                                    </button>
                                </span>
                            }

                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <p id="fileUploadWarning" class="text-danger d-none">You must post a message to add these files to this work request.</p>
                            <ul id="fileUploadTitles"></ul>
                        </div>
                    </div>
                    <div class="row">
                        @if (Model.ProcessDeviationReason != null)
                        {
                            <div class="col" id="process-deviation-reason-wrapper">
                                <div class="alert-danger mt-3 p-3 rounded">
                                    <label class="col-form-label w-100">@Model.MultipleAuthorisationsWarning</label>
                                    <label class="col-form-label">Reason for Deviation<i class="fa fa-info-circle ms-1" title="You have filled out multiple steps. Explain why you're completing multiple steps." data-bs-toggle="tooltip"></i></label>
                                    <input class="form-control" asp-for="ProcessDeviationReason.Reason" required />
                                    <span asp-validation-for="ProcessDeviationReason.Reason" class="text-danger"></span>
                                </div>
                            </div>
                        }
                    </div>
                </form>
            </div>
            <div id="printInfoTag" class="row mt-5">
                <div class="col">
                    <p class="text-center p-3">Request log exported by @User.Identity.Name from <span id="getUrlForPrint"></span> on @DateTime.Now</p>
                </div>
            </div>
        </div>
    </div>
</div>

<partial name="_AddSubTaskModalPartial" model="Model.SubTaskAddViewModel" />
<partial name="_SubscribeOtherUserModalPartial" model="Model.SubscribeOtherUsersViewModel" />

