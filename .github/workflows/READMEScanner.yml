name: Org README Review Checker

on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check repos
        env:
          ORG: uoy-trials
          TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
          THRESHOLD_DAYS: 7
          RETIRE_THRESHOLD: 28
        run: |
          TODAY=$(date +%s)
          DUE_LIST=""
          RETIRE_LIST=""

          echo "Fetching repos for $ORG..."
          repos=$(gh api --paginate /orgs/$ORG/repos \
            -q '.[] | select(.archived == false and (.name | startswith("stats-") | not)) | .name')

          for repo in $repos; do
            echo "Checking $repo..."

            # Skip forks
            is_fork=$(gh api /repos/$ORG/$repo -q '.fork')
            if [ "$is_fork" = "true" ]; then
              echo "$repo is a fork â€” skipping"
              continue
            fi

            # Fetch README
            readme=$(gh api /repos/$ORG/$repo/readme -q '.content' | base64 --decode)

            if [[ "$readme" ]]; then
              # Extract fields safely
              status=$(echo "$readme" | grep "Repo-Status" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              contents=$(echo "$readme" | grep "Repo-Contents" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              service_name=$(echo "$readme" | grep "Repo-Service-Name" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              ownership=$(echo "$readme" | grep "Repo-Ownership-Rating" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              quality=$(echo "$readme" | grep "Repo-Quality-Rating" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              next_review=$(echo "$readme" | grep "Repo-Next-Review-Due" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              retirement=$(echo "$readme" | grep "Repo-Expected-Retirement-Date" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")

              # Review due
              if [ -n "$next_review" ]; then
                reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
                diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
                if [ "$reviewEpoch" -gt 0 ] && [ "$diffDays" -le $THRESHOLD_DAYS ]; then
                  DUE_LIST="$DUE_LIST\n- $repo | Status: $status | Next Review: $next_review | Service: $service_name"
                fi
              fi

              # Retirement due
              if [ -n "$retirement" ]; then
                retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
                retireDays=$(( (retireEpoch - TODAY) / 86400 ))
                if [ "$retireEpoch" -gt 0 ] && [ "$retireDays" -le $RETIRE_THRESHOLD ]; then
                  RETIRE_LIST="$RETIRE_LIST\n- $repo | Status: $status | Retirement: $retirement | Service: $service_name"
                fi
              fi

            fi

          done 

          # Output results
          echo -e "Reviews due soon:$DUE_LIST"
          echo -e "Repositories retiring soon:$RETIRE_LIST"

          echo "due_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DUE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "retire_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RETIRE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
