name: Org README Review Checker
#| select(.archived == false and (.name | startswith("stats-") | not))
on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check repos
        env:
          ORG: uoy-trials
          TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
        run: |
          THRESHOLD_DAYS=7
          TODAY=$(date +%s)
      
          echo "Fetching repos for $ORG..."
      
          json=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/orgs/$ORG/repos?per_page=100&type=all)

            echo "pls"
          echo "$json"
          
          repos=$(echo "$json" | jq -r '.[] | select(.archived == false and (.name | startswith("stats-") | not)) | .name')
      
          DUE_LIST=""
      
          for repo in $repos; do
            echo "Checking $repo"
      
            readme=$(curl -s -f \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.raw" \
              https://api.github.com/repos/$ORG/$repo/readme)
      
            if [[ "$readme" == *"Repo-Next-Review-Due"* ]]; then
              dateStr=$(echo "$readme" | grep "Repo-Next-Review-Due" | sed 's/.*: //')
      
              reviewEpoch=$(date -d "$dateStr" +%s 2>/dev/null || echo 0)
      
              if [ "$reviewEpoch" -gt 0 ]; then
                diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
      
                if [ "$diffDays" -le "$THRESHOLD_DAYS" ]; then
                  DUE_LIST="$DUE_LIST\n- $repo ($dateStr)"
                fi
              fi
            fi
          done
      
          echo -e "Repos due:$DUE_LIST"
      
          echo "due_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DUE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
