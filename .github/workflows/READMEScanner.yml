name: Org README Review Checker
#| select(.archived == false and (.name | startswith("stats-") | not))
on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check repos
        env:
          ORG: uoy-trials
          TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
        run: |
          THRESHOLD_DAYS=7
          TODAY=$(date +%s)
      
          echo "Fetching repos for $ORG..."
      
          repos=$(gh api --paginate /orgs/$ORG/repos \
          -q '.[] | select(.archived == false and (.name | startswith("stats-") | not)) | .name')

          DUE_LIST=""
      
          for repo in $repos; do
          echo "Checking $repo..."
        
          # Get README content (base64-decoded)
          readme=$(gh api /repos/$ORG/$repo/readme -q '.content' | base64 --decode)
        
          if [[ "$readme" == *"Repo-Next-Review-Due"* ]]; then
            dateStr=$(echo "$readme" | grep "Repo-Next-Review-Due" | sed 's/.*: //')
            
            # Convert to epoch for comparison
            reviewEpoch=$(date -d "$dateStr" +%s 2>/dev/null || echo 0)
        
            if [ "$reviewEpoch" -gt 0 ]; then
              diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
              
              echo "$repo - Review date: $dateStr - in $diffDays days"
        
              if [ "$diffDays" -le $THRESHOLD_DAYS ]; then
                DUE_LIST="$DUE_LIST\n- $repo ($dateStr)"
              fi
            else
              echo "$repo - Review date not parseable: $dateStr"
            fi
          else
            echo "$repo - No review date found"
          fi
          done

      
          echo -e "Repos due:$DUE_LIST"
      
          echo "due_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DUE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
