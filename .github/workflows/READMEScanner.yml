name: Org README Review Checker
#| select(.archived == false and (.name | startswith("stats-") | not))
on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check repos
        env:
          ORG: uoy-trials
          TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.AUTH_GITHUB_TOKEN }}
        run: |
          THRESHOLD_DAYS=7
          TODAY=$(date +%s)
      
          echo "Fetching repos for $ORG..."
      
          repos=$(gh api --paginate /orgs/$ORG/repos \
          -q '.[] | select(.archived == false and (.name | startswith("stats-") | not)) | .name')

          DUE_LIST=""
      
          for repo in $repos; do
          echo "Checking $repo..."
        
          # Fetch README content (base64-decoded automatically)
          readme=$(gh api /repos/$ORG/$repo/readme -q '.content' | base64 --decode)
        
          # Only proceed if README exists
          if [[ "$readme" ]]; then
        
            # Extract all fields
            status=$(echo "$readme" | grep "Repo-Status" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            contents=$(echo "$readme" | grep "Repo-Contents" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            service_name=$(echo "$readme" | grep "Repo-Service-Name" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            ownership=$(echo "$readme" | grep "Repo-Ownership-Rating" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            quality=$(echo "$readme" | grep "Repo-Quality-Rating" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            next_review=$(echo "$readme" | grep "Repo-Next-Review-Due" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')
            retirement=$(echo "$readme" | grep "Repo-Expected-Retirement-Date" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//')

            # Convert review date to epoch for comparison
            reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
        
            if [ "$reviewEpoch" -gt 0 ]; then
              diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
        
              # Print all info for this repo
            #  echo "Repo: $repo"
            #  echo "  Status: $status"
           #   echo "  Contents: $contents"
           #   echo "  Service Name: $service_name"
          #    echo "  Ownership Rating: $ownership"
            #  echo "  Quality Rating: $quality"
           #   echo "  Next Review Due: $next_review (in $diffDays days)"
           #   echo "  Expected Retirement: $retirement"
            #  echo "-----------------------------------"
        
               # Process review date for due list
            if [ -n "$next_review" ]; then
              reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
              diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
              if [ "$reviewEpoch" -gt 0 ] && [ "$diffDays" -le $THRESHOLD_DAYS ]; then
                DUE_LIST="$DUE_LIST\n- $repo | Status: $status | Next Review: $next_review | Service: $service_name"
              fi
            fi
          
            # Process retirement date for retire list
            if [ -n "$retirement" ]; then
              retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
              retireDays=$(( (retireEpoch - TODAY) / 86400 ))
              if [ "$retireEpoch" -gt 0 ] && [ "$retireDays" -le $RETIRE_THRESHOLD ]; then
                RETIRE_LIST="$RETIRE_LIST\n- $repo | Status: $status | Retirement: $retirement | Service: $service_name"
              fi
            fi
           fi
          done

          # Output for workflow or email
          echo -e "Reviews due soon:$DUE_LIST"
          echo -e "Repositories retiring soon:$RETIRE_LIST"
      
          echo "due_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DUE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
