name: README Scanner

on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch repos
        id: repos
        uses: actions/github-script@v7
        env:
          ORG: uoy-trials
        with:
          github-token: ${{ secrets.AUTH_GITHUB_TOKEN }}
          script: |
            const org = process.env.ORG;
            const repos = await github.paginate(
              github.rest.repos.listForOrg,
              { org }
            );
            const filtered = repos
              .filter(r => !r.archived && !r.name.startsWith("stats-"))
              .map(r => r.name);
            
            return filtered;

      - name: Check repos metadata
        uses: actions/github-script@v7
        env:
          ORG: uoy-trials
          REPO_LIST: ${{ steps.repos.outputs.result }}
          THRESHOLD_DAYS: 30
        with:
          github-token: ${{ secrets.AUTH_GITHUB_TOKEN }}
          script: |
            const org = process.env.ORG;
            console.log(`$org`);
            const repoNames = JSON.parse(process.env.REPO_LIST);
            console.log(`$repoNames`);
            const today = new Date();
            const thresholdDays = parseInt(process.env.THRESHOLD_DAYS);
            
            let dueList = "";
            let retireList = "";

            for (const name of repoNames) {
              console.log(`Processing: ${name}`);
              
                const { data: readmeFile } = await github.rest.repos.getReadme({
                  owner: org,
                  repo: name,
                });
                
                const content = Buffer.from(readmeFile.content, 'base64').toString('utf-8');

                const getMeta = (key) => {
                  const regex = new RegExp(`${key}\\s*:\\s*(.*)`, 'i');
                  const match = content.match(regex);
                  return match ? match[1].trim() : null;
                };

                const status = getMeta("Repo-Status") || "Unknown";
                const serviceName = getMeta("Repo-Service-Name") || "Unknown";
                const nextReviewStr = getMeta("Repo-Next-Review-Due");
                const retirementStr = getMeta("Repo-Expected-Retirement-Date");

                const getDiffDays = (dateStr) => {
                  if (!dateStr || dateStr.toLowerCase() === 'tbc') return null;
                  const targetDate = new Date(dateStr);
                  if (isNaN(targetDate.getTime())) return null;
                  return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                };

                const reviewDiff = getDiffDays(nextReviewStr);
                // FIX: Changed repo.name to name
                if (reviewDiff !== null && reviewDiff <= thresholdDays) {
                  dueList += `\n- ${name} | Status: ${status} | Next Review: ${nextReviewStr} | Service: ${serviceName}`;
                }

                const retireDiff = getDiffDays(retirementStr);
                // FIX: Changed repo.name to name
                if (retireDiff !== null && retireDiff <= thresholdDays) {
                  retireList += `\n- ${name} | Status: ${status} | Retirement: ${retirementStr} | Service: ${serviceName}`;
                }
            }

            core.exportVariable('DUE_LIST', dueList.trim());
            core.exportVariable('RETIRE_LIST', retireList.trim());

      - name: Build tables
        shell: bash
        run: |
          TODAY=$(date +%s)

          # Reviews table
          REVIEWS_TABLE="| Repo | Status | Next Review | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            next_review=$(echo "$line" | cut -d'|' -f3 | sed 's/Next Review: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
            diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            rows+=("$reviewEpoch|$repo|$status|$next_review|$service|$diffDays|$due_status")
          done <<< "$DUE_LIST"

          IFS=$'\n' sorted_rows=($(sort -n <<<"${rows[*]}"))
          for row in "${sorted_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            REVIEWS_TABLE="$REVIEWS_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "REVIEWS_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$REVIEWS_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Retirement table
          RETIRE_TABLE="| Repo | Status | Retirement | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          retire_rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            retirement=$(echo "$line" | cut -d'|' -f3 | sed 's/Retirement: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
            diffDays=$(( (retireEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            retire_rows+=("$retireEpoch|$repo|$status|$retirement|$service|$diffDays|$due_status")
          done <<< "$RETIRE_LIST"

          IFS=$'\n' sorted_retire_rows=($(sort -n <<<"${retire_rows[*]}"))
          for row in "${sorted_retire_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            RETIRE_TABLE="$RETIRE_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "RETIRE_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$RETIRE_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          subject: "GitHub README Scanner"
          to: ytu-techsupport-group@york.ac.uk
          from: "${{ github.repository }} <${{ secrets.MAIL_USERNAME }}>"
          reply_to: ytu-techsupport-group@york.ac.uk
          content_type: text/markdown
          body: |
            ## Repos with Reviews Due Soon
            ${{ env.REVIEWS_TABLE }}

            ## Repos Retiring Soon
            ${{ env.RETIRE_TABLE }}
