name: README Scanner

on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:
  push:
    branches:
      - 30-readme-scanner

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch repos
        id: repos
        uses: actions/github-script@v7
        env:
          ORG: uoy-trials
        with:
          github-token: ${{ secrets.AUTH_GITHUB_TOKEN }}
          script: |
            const org = process.env.ORG;
            console.log("Organization:", org);
            
            const repos = await github.paginate(
              github.rest.repos.listForOrg,
              { org }
            );
            
            const filtered = repos
              .filter(r => !r.archived && !r.name.startsWith("stats-"))
              .map(r => r.name);
            
            console.log("Filtered Repos:", filtered);
            return filtered.join("\n");

      - name: Check repos
        env:
          ORG: uoy-trials
          REPOS: ${{ steps.repos.outputs.result }}
          THRESHOLD_DAYS: 28
          RETIRE_THRESHOLD: 28
        run: |
          const org = process.env.ORG;
            const thresholdDays = parseInt(process.env.THRESHOLD_DAYS);
            const retireThreshold = parseInt(process.env.RETIRE_THRESHOLD);
            const today = new Date();
            
            let dueList = "";
            let retireList = "";

            const repos = await github.paginate(github.rest.repos.listForOrg, { org });
            const filteredRepos = repos.filter(r => !r.archived && !r.name.startsWith("stats-"));

            for (const repo of filteredRepos) {
              console.log(`Checking ${repo.name}...`);
              try {
                // 2. Fetch README
                const { data: readmeFile } = await github.rest.repos.getReadme({
                  owner: org,
                  repo: repo.name,
                });
                
                const content = Buffer.from(readmeFile.content, 'base64').toString('utf-8');

                const getMeta = (key) => {
                  const regex = new RegExp(`${key}\\s*:\\s*(.*)`, 'i');
                  const match = content.match(regex);
                  return match ? match[1].trim() : null;
                };

                const status = getMeta("Repo-Status") || "Unknown";
                const serviceName = getMeta("Repo-Service-Name") || "Unknown";
                const nextReview = getMeta("Repo-Next-Review-Due");
                const retirement = getMeta("Repo-Expected-Retirement-Date");

                const checkDate = (dateStr, daysLimit) => {
                  if (!dateStr) return false;
                  const targetDate = new Date(dateStr);
                  if (isNaN(targetDate)) return false;
                  const diffTime = targetDate - today;
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  return diffDays <= daysLimit;
                };

                if (checkDate(nextReview, thresholdDays)) {
                  dueList += `\n- ${repo.name} | Status: ${status} | Next Review: ${nextReview} | Service: ${serviceName}`;
                }

                if (checkDate(retirement, retireThreshold)) {
                  retireList += `\n- ${repo.name} | Status: ${status} | Retirement: ${retirement} | Service: ${serviceName}`;
                }

              } catch (e) {
                console.log(`No README found for ${repo.name} or error occurred.`);
              }
            }

            core.exportVariable('DUE_LIST', dueList);
            core.exportVariable('RETIRE_LIST', retireList);

      - name: Build tables
        shell: bash
        run: |
          TODAY=$(date +%s)

          # Reviews table
          REVIEWS_TABLE="| Repo | Status | Next Review | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            next_review=$(echo "$line" | cut -d'|' -f3 | sed 's/Next Review: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
            diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            rows+=("$reviewEpoch|$repo|$status|$next_review|$service|$diffDays|$due_status")
          done <<< "$DUE_LIST"

          IFS=$'\n' sorted_rows=($(sort -n <<<"${rows[*]}"))
          for row in "${sorted_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            REVIEWS_TABLE="$REVIEWS_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "REVIEWS_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$REVIEWS_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Retirement table
          RETIRE_TABLE="| Repo | Status | Retirement | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          retire_rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            retirement=$(echo "$line" | cut -d'|' -f3 | sed 's/Retirement: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
            diffDays=$(( (retireEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            retire_rows+=("$retireEpoch|$repo|$status|$retirement|$service|$diffDays|$due_status")
          done <<< "$RETIRE_LIST"

          IFS=$'\n' sorted_retire_rows=($(sort -n <<<"${retire_rows[*]}"))
          for row in "${sorted_retire_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            RETIRE_TABLE="$RETIRE_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "RETIRE_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$RETIRE_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          subject: "GitHub README Scanner"
          to: ytu-techsupport-group@york.ac.uk
          from: "${{ github.repository }} <${{ secrets.MAIL_USERNAME }}>"
          reply_to: ytu-techsupport-group@york.ac.uk
          content_type: text/markdown
          body: |
            ## Repos with Reviews Due Soon
            ${{ env.REVIEWS_TABLE }}

            ## Repos Retiring Soon
            ${{ env.RETIRE_TABLE }}
