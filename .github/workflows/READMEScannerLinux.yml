name: README Scanner

on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:
  push:
    branches:
      - 30-readme-scanner

jobs:
  check:
    runs-on: ubuntu

    steps:
      - uses: actions/checkout@v4

      - name: Fetch repos
        id: repos
        uses: actions/github-script@v7
        env:
          ORG: uoy-trials
        with:
          github-token: ${{ secrets.AUTH_GITHUB_TOKEN }}
          script: |
            const org = process.env.ORG;
            const repos = await github.paginate(
              github.rest.repos.listForOrg,
              { org }
            );
            const filtered = repos
              .filter(r => !r.archived && !r.name.startsWith("stats-"))
              .map(r => r.name);
            return filtered.join("\n");

      - name: Check repos
        env:
          ORG: uoy-trials
          REPOS: ${{ steps.repos.outputs.result }}
          THRESHOLD_DAYS: 28
          RETIRE_THRESHOLD: 28
        run: |
          TODAY=$(date +%s)
          DUE_LIST=""
          RETIRE_LIST=""

          for repo in $REPOS; do
            echo "Checking $repo..."

            # Fetch README using GitHub API via curl
            readme=$(curl -s -H "Authorization: token ${{ secrets.AUTH_GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$ORG/$repo/readme | jq -r '.content' | base64 --decode)

            if [[ "$readme" ]]; then
              status=$(echo "$readme" | grep "Repo-Status" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              service_name=$(echo "$readme" | grep "Repo-Service-Name" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              next_review=$(echo "$readme" | grep "Repo-Next-Review-Due" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")
              retirement=$(echo "$readme" | grep "Repo-Expected-Retirement-Date" | head -n1 | cut -d':' -f2- | sed 's/^ *//;s/ *$//' || echo "")

              # Review due
              if [ -n "$next_review" ]; then
                reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
                diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
                if [ "$reviewEpoch" -gt 0 ] && [ "$diffDays" -le $THRESHOLD_DAYS ]; then
                  DUE_LIST="$DUE_LIST\n- $repo | Status: $status | Next Review: $next_review | Service: $service_name"
                fi
              fi

              # Retirement due
              if [ -n "$retirement" ]; then
                retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
                retireDays=$(( (retireEpoch - TODAY) / 86400 ))
                if [ "$retireEpoch" -gt 0 ] && [ "$retireDays" -le $RETIRE_THRESHOLD ]; then
                  RETIRE_LIST="$RETIRE_LIST\n- $repo | Status: $status | Retirement: $retirement | Service: $service_name"
                fi
              fi
            fi
          done

          # Export lists for next steps
          echo "DUE_LIST<<EOF" >> $GITHUB_ENV
          echo -e "$DUE_LIST" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "RETIRE_LIST<<EOF" >> $GITHUB_ENV
          echo -e "$RETIRE_LIST" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build tables
        shell: bash
        run: |
          TODAY=$(date +%s)

          # Reviews table
          REVIEWS_TABLE="| Repo | Status | Next Review | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            next_review=$(echo "$line" | cut -d'|' -f3 | sed 's/Next Review: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            reviewEpoch=$(date -d "$next_review" +%s 2>/dev/null || echo 0)
            diffDays=$(( (reviewEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            rows+=("$reviewEpoch|$repo|$status|$next_review|$service|$diffDays|$due_status")
          done <<< "$DUE_LIST"

          IFS=$'\n' sorted_rows=($(sort -n <<<"${rows[*]}"))
          for row in "${sorted_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            REVIEWS_TABLE="$REVIEWS_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "REVIEWS_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$REVIEWS_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Retirement table
          RETIRE_TABLE="| Repo | Status | Retirement | Service | Days | Due Status |\n| --- | --- | --- | --- | --- | --- |"
          retire_rows=()
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | cut -d'|' -f1 | sed 's/- //;s/^ *//;s/ *$//')
            status=$(echo "$line" | cut -d'|' -f2 | sed 's/Status: //;s/^ *//;s/ *$//')
            retirement=$(echo "$line" | cut -d'|' -f3 | sed 's/Retirement: //;s/^ *//;s/ *$//')
            service=$(echo "$line" | cut -d'|' -f4 | sed 's/Service: //;s/^ *//;s/ *$//')

            retireEpoch=$(date -d "$retirement" +%s 2>/dev/null || echo 0)
            diffDays=$(( (retireEpoch - TODAY) / 86400 ))
            due_status="due soon"
            if [ "$diffDays" -lt 0 ]; then
              due_status="overdue"
              diffDays=$(( -diffDays ))
            fi
            retire_rows+=("$retireEpoch|$repo|$status|$retirement|$service|$diffDays|$due_status")
          done <<< "$RETIRE_LIST"

          IFS=$'\n' sorted_retire_rows=($(sort -n <<<"${retire_rows[*]}"))
          for row in "${sorted_retire_rows[@]}"; do
            IFS='|' read -r _epoch _repo _status _date _service _days _dueStatus <<< "$row"
            RETIRE_TABLE="$RETIRE_TABLE\n| $_repo | $_status | $_date | $_service | $_days | $_dueStatus |"
          done

          echo "RETIRE_TABLE<<EOF" >> $GITHUB_ENV
          echo -e "$RETIRE_TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: dawidd6/action-send-mail@v5
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          subject: "GitHub README Scanner"
          to: ytu-techsupport-group@york.ac.uk
          from: "${{ github.repository }} <${{ secrets.MAIL_USERNAME }}>"
          reply_to: ytu-techsupport-group@york.ac.uk
          content_type: text/markdown
          body: |
            ## Repos with Reviews Due Soon
            ${{ env.REVIEWS_TABLE }}

            ## Repos Retiring Soon
            ${{ env.RETIRE_TABLE }}
